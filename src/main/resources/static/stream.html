<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gemini-style Chat ‚Äî Enhanced UX + Complete AI Responses</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>

    <style>
        :root {
          --anim-ease: cubic-bezier(.2,.9,.2,1);
          --anim-bounce: cubic-bezier(.68,-.6,.32,1.6);
          --anim-smooth: cubic-bezier(.25,.46,.45,.94);
          --sidebar-w: 20rem;
          --accent: #2563eb;
          --accent-light: #dbeafe;
          --accent-dark: #1e40af;
          --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
          --shadow-soft: 0 4px 20px rgba(0,0,0,0.08);
          --shadow-hover: 0 8px 25px rgba(0,0,0,0.15);
          --blur-backdrop: blur(20px);
        }

        /* Respect reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
          * { animation: none !important; transition: none !important; }
        }

        /* Advanced font loading and smoothing */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 75%, #f5576c 100%);
          background-size: 400% 400%;
          animation: gradientShift 15s ease infinite;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto;
          color: #0f172a;
          height: 100vh;
          margin: 0;
          overflow: hidden;
        }

        @keyframes gradientShift {
          0% { background-position: 0% 50%; }
          50% { background-position: 100% 50%; }
          100% { background-position: 0% 50%; }
        }

        /* Glass morphism container */
        .glass-container {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: var(--blur-backdrop);
          border: 1px solid rgba(255, 255, 255, 0.3);
          box-shadow: var(--shadow-soft);
        }

        /* === STARTUP ANIMATION SYSTEM === */
        .app-init .animate-start {
          opacity: 0;
          transform: translateY(20px) scale(0.95);
          transition: all 0.6s var(--anim-ease);
        }

        .app-init .sidebar {
          transform: translateX(-100px) rotateY(15deg);
          opacity: 0;
        }

        .app-init .history-item {
          opacity: 0;
          transform: translateX(-30px) rotateZ(2deg);
        }

        .app-init .greeting-card {
          opacity: 0;
          transform: scale(0.8) translateY(40px) rotateX(10deg);
        }

        .app-init .floating-input {
          transform: translateY(100px) scale(0.9);
          opacity: 0;
        }

        .show {
          opacity: 1 !important;
          transform: none !important;
        }

        /* === ADVANCED TYPING ANIMATION === */
        .typing-indicator {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 12px 16px;
          background: rgba(255, 255, 255, 0.9);
          border-radius: 18px;
          backdrop-filter: blur(10px);
        }

        .typing-dots {
          display: flex;
          gap: 4px;
        }

        .typing-dots span {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: linear-gradient(45deg, #667eea, #764ba2);
          animation: typingPulse 1.4s ease-in-out infinite;
        }

        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingPulse {
          0%, 60%, 100% {
            transform: scale(1) translateY(0);
            opacity: 0.7;
          }
          30% {
            transform: scale(1.2) translateY(-8px);
            opacity: 1;
          }
        }

        /* === ENHANCED SIDEBAR === */
        .sidebar {
          width: var(--sidebar-w);
          min-width: 16rem;
          backdrop-filter: var(--blur-backdrop);
          background: rgba(255, 255, 255, 0.95);
          border-right: 1px solid rgba(255, 255, 255, 0.3);
          box-shadow: 4px 0 20px rgba(0,0,0,0.1);
          transition: all 0.3s var(--anim-ease);
        }

        .sidebar:hover {
          box-shadow: 6px 0 30px rgba(0,0,0,0.15);
        }

        .sidebar button,
        .sidebar input {
          transition: all 0.25s var(--anim-smooth);
        }

        .sidebar button:hover {
          background: var(--accent-light);
          transform: translateX(4px) scale(1.02);
          box-shadow: var(--shadow-hover);
        }

        /* === ENHANCED LOGO === */
        .logo-wrap {
          display: flex;
          align-items: center;
          gap: 1rem;
          position: relative;
        }

        .app-logo {
          width: 48px;
          height: 48px;
          border-radius: 12px;
          padding: 6px;
          transition: all 0.3s var(--anim-bounce);
          cursor: pointer;
          position: relative;
          overflow: hidden;
        }

        .app-logo::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
          transition: all 0.5s var(--anim-ease);
        }

        .app-logo:hover {
          transform: rotateY(180deg) scale(1.1);
          box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .app-logo:hover::before {
          left: 100%;
        }

        /* === FLOATING PARTICLES === */
        .particles {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          z-index: 1;
        }

        .particle {
          position: absolute;
          width: 4px;
          height: 4px;
          background: rgba(255, 255, 255, 0.6);
          border-radius: 50%;
          animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
          0%, 100% {
            transform: translateY(0) rotate(0deg);
            opacity: 1;
          }
          50% {
            transform: translateY(-20px) rotate(180deg);
            opacity: 0.5;
          }
        }

        /* === ADVANCED MESSAGE BUBBLES === */
        .message-row {
          animation: messageSlide 0.5s var(--anim-smooth) forwards;
          transform-origin: bottom;
        }

        @keyframes messageSlide {
          from {
            opacity: 0;
            transform: translateY(30px) scale(0.9) rotateX(15deg);
          }
          to {
            opacity: 1;
            transform: translateY(0) scale(1) rotateX(0deg);
          }
        }

        .msg-user {
          background: var(--gradient-primary);
          color: white;
          border-radius: 20px 20px 4px 20px;
          margin-left: auto;
          position: relative;
          overflow: hidden;
        }

        .msg-user::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
          transition: all 0.6s var(--anim-ease);
        }

        .msg-user:hover::before {
          left: 100%;
        }

        .msg-bot {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: blur(10px);
          border-radius: 20px 20px 20px 4px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          box-shadow: 0 8px 25px rgba(0,0,0,0.08);
          margin-right: auto;
          transition: all 0.3s var(--anim-ease);
        }

        .msg-bot:hover {
          transform: translateY(-2px);
          box-shadow: 0 12px 35px rgba(0,0,0,0.12);
        }

        /* === MESSAGE CONTENT IMPROVEMENTS === */
        .message-content {
          line-height: 1.6;
          word-wrap: break-word;
          overflow-wrap: break-word;
          hyphens: auto;
        }

        .message-content pre {
          background: rgba(0,0,0,0.05);
          border-radius: 8px;
          padding: 12px;
          margin: 8px 0;
          overflow-x: auto;
          border-left: 3px solid var(--accent);
        }

        .message-content code {
          background: rgba(0,0,0,0.05);
          padding: 2px 4px;
          border-radius: 4px;
          font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }

        .message-content ul, .message-content ol {
          margin: 12px 0;
          padding-left: 20px;
        }

        .message-content li {
          margin: 4px 0;
        }

        /* === ENHANCED GREETING CARD === */
        .greeting-card {
          background: rgba(255, 255, 255, 0.95);
          backdrop-filter: var(--blur-backdrop);
          padding: 3rem;
          border-radius: 24px;
          border: 1px solid rgba(255, 255, 255, 0.3);
          box-shadow: 0 20px 40px rgba(0,0,0,0.1);
          position: relative;
          overflow: hidden;
          transition: all 0.4s var(--anim-ease);
        }

        .greeting-card::before {
          content: '';
          position: absolute;
          top: -50%;
          left: -50%;
          width: 200%;
          height: 200%;
          background: conic-gradient(from 0deg, transparent, rgba(102, 126, 234, 0.1), transparent);
          animation: rotate 20s linear infinite;
        }

        .greeting-card > * {
          position: relative;
          z-index: 2;
        }

        @keyframes rotate {
          to { transform: rotate(360deg); }
        }

        .greeting-card:hover {
          transform: translateY(-5px) scale(1.02);
          box-shadow: 0 25px 50px rgba(0,0,0,0.15);
        }

        /* === FLOATING INPUT ENHANCEMENT === */
        .floating-input {
          background: rgba(255, 255, 255, 0.9);
          backdrop-filter: var(--blur-backdrop);
          border: 1px solid rgba(255, 255, 255, 0.3);
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
          transition: all 0.3s var(--anim-ease);
          border-radius: 24px;
          position: relative;
          overflow: hidden;
        }

        .floating-input::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 2px;
          background: var(--gradient-primary);
          transition: all 0.4s var(--anim-ease);
        }

        .floating-input:focus-within {
          box-shadow: 0 15px 40px rgba(102, 126, 234, 0.2);
          transform: translateY(-2px);
        }

        .floating-input:focus-within::before {
          left: 100%;
        }

        /* === ENHANCED BUTTONS === */
        #send-btn {
          background: var(--gradient-primary);
          transition: all 0.25s var(--anim-bounce);
          border-radius: 16px;
          position: relative;
          overflow: hidden;
        }

        #send-btn::before {
          content: '';
          position: absolute;
          top: 50%;
          left: 50%;
          width: 0;
          height: 0;
          background: rgba(255, 255, 255, 0.3);
          border-radius: 50%;
          transition: all 0.3s var(--anim-ease);
          transform: translate(-50%, -50%);
        }

        #send-btn:hover {
          transform: translateY(-3px) scale(1.05);
          box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        #send-btn:hover::before {
          width: 200%;
          height: 200%;
        }

        #send-btn:active {
          transform: translateY(-1px) scale(1.02);
        }

        /* === HISTORY ITEMS ENHANCEMENT === */
        .history-item {
          background: transparent;
          border: 1px solid transparent;
          width: 100%;
          text-align: left;
          transition: all 0.3s var(--anim-ease);
          border-radius: 12px;
          position: relative;
          overflow: hidden;
        }

        .history-item::before {
          content: '';
          position: absolute;
          top: 0;
          left: -100%;
          width: 100%;
          height: 100%;
          background: linear-gradient(90deg, transparent, rgba(37, 99, 235, 0.1), transparent);
          transition: all 0.4s var(--anim-ease);
        }

        .history-item:hover {
          background: rgba(255, 255, 255, 0.7);
          border-color: var(--accent-light);
          transform: translateX(8px) scale(1.02);
        }

        .history-item:hover::before {
          left: 100%;
        }

        .history-item.active {
          background: var(--accent-light);
          border-color: var(--accent);
          transform: translateX(6px);
          box-shadow: 0 4px 15px rgba(37, 99, 235, 0.2);
        }

        /* === MICRO-INTERACTIONS === */
        .pulse-on-hover {
          transition: all 0.2s var(--anim-ease);
        }

        .pulse-on-hover:hover {
          animation: pulse 1s infinite;
        }

        @keyframes pulse {
          0% { transform: scale(1); }
          50% { transform: scale(1.05); }
          100% { transform: scale(1); }
        }

        /* === SCROLL ANIMATIONS === */
        .smooth-scroll {
          scroll-behavior: smooth;
          scrollbar-width: thin;
          scrollbar-color: rgba(37, 99, 235, 0.3) transparent;
        }

        .smooth-scroll::-webkit-scrollbar {
          width: 6px;
        }

        .smooth-scroll::-webkit-scrollbar-track {
          background: transparent;
        }

        .smooth-scroll::-webkit-scrollbar-thumb {
          background: rgba(37, 99, 235, 0.3);
          border-radius: 6px;
          transition: all 0.2s var(--anim-ease);
        }

        .smooth-scroll::-webkit-scrollbar-thumb:hover {
          background: rgba(37, 99, 235, 0.5);
        }

        /* === RESPONSIVE ENHANCEMENTS === */
        @media (max-width: 880px) {
          .sidebar {
            display: none;
          }
          .floating-input {
            width: calc(100% - 16px);
            margin: 0 8px;
          }
          .greeting-card {
            margin: 0 16px;
            padding: 2rem;
          }
        }

        @media (max-width: 640px) {
          :root {
            --sidebar-w: 16rem;
          }
          .greeting-card {
            padding: 1.5rem;
          }
        }

        /* === LOADING STATE === */
        .loading-shimmer {
          background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
          background-size: 200% 100%;
          animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
          0% { background-position: -200% 0; }
          100% { background-position: 200% 0; }
        }

        /* === STATUS INDICATORS === */
        .status-indicator {
          width: 8px;
          height: 8px;
          border-radius: 50%;
          background: #10b981;
          animation: statusPulse 2s infinite;
        }

        @keyframes statusPulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.5; transform: scale(1.2); }
        }
    </style>
</head>

<body class="app-init flex h-screen">
<!-- Floating Particles Background -->
<div class="particles" id="particles"></div>

<!-- Sidebar -->
<aside class="sidebar flex flex-col p-0 animate-start glass-container" data-animate="sidebar">
    <div class="p-5 border-b border-white/20">
        <div class="flex items-center justify-between">
            <!-- Enhanced Logo -->
            <div class="logo-wrap" aria-hidden="false">
                <div class="app-logo pulse-on-hover glass-container" title="Chat logo" role="img" aria-label="Chat logo">
                    <svg viewBox="0 0 64 64" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" focusable="false">
                        <defs>
                            <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
                                <stop offset="0" stop-color="#667eea"/>
                                <stop offset="0.5" stop-color="#764ba2"/>
                                <stop offset="1" stop-color="#f093fb"/>
                            </linearGradient>
                        </defs>
                        <rect rx="12" width="64" height="64" fill="url(#g1)" opacity="0.1"></rect>
                        <g transform="translate(12,12) scale(0.6)">
                            <path d="M24 2c6 0 10 4 10 10s-4 10-10 10-10-4-10-10 4-10 10-10z" fill="none" stroke="#667eea" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M4 26c0-6 4-10 10-10s10 4 10 10-4 10-10 10S4 32 4 26z" fill="none" stroke="#764ba2" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M24 50c-6 0-10-4-10-10s4-10 10-10 10 4 10 10-4 10-10 10z" fill="none" stroke="#f093fb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M44 26c0 6-4 10-10 10s-10-4-10-10 4-10 10-10 10 4 10 10z" fill="none" stroke="#667eea" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                    </svg>
                </div>
            </div>

            <button id="new-chat-btn" class="ml-3 px-4 py-2 text-white rounded-xl text-sm font-medium pulse-on-hover" style="background:var(--gradient-primary)" aria-label="New chat">
                <span>‚ú® New</span>
            </button>
        </div>
    </div>

    <div class="p-4">
        <input id="history-search" placeholder="üîç Search chats..." class="w-full p-3 rounded-xl border border-white/30 text-sm bg-white/50 backdrop-blur-md transition-all duration-300 focus:ring-2 focus:ring-blue-400/50" />
    </div>

    <div id="chat-history" class="flex-1 overflow-auto px-3 py-2 space-y-2 smooth-scroll"></div>

    <div class="p-4 border-t border-white/20">
        <div class="flex items-center justify-between text-sm text-gray-600">
            <div class="flex items-center gap-2">
                <div class="status-indicator"></div>
                <span>Saved locally</span>
            </div>
            <button id="clear-history" class="text-red-500 hover:underline transition-all duration-200 hover:text-red-600">Clear</button>
        </div>
    </div>
</aside>

<!-- Main area -->
<main class="flex-1 flex flex-col relative">
    <div id="center-area" class="flex-1 overflow-auto smooth-scroll">
        <div id="greeting" class="h-full flex items-center justify-center px-6">
            <div class="max-w-2xl text-center greeting-card greeting-pop animate-start" data-animate="greeting">
                <h2 class="text-4xl font-bold bg-gradient-to-r from-purple-600 via-blue-600 to-blue-800 bg-clip-text text-transparent">
                    Hello, Rishabh! üëã
                </h2>
                <p class="mt-4 text-gray-600 text-lg leading-relaxed">
                    Ask anything ‚Äî code, explanations, help or ideas.
                    <br/>
                    <span class="text-sm font-medium bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                            ‚ú® Messages stream in with beautiful animations
                        </span>
                </p>
            </div>
        </div>

        <div id="chat-container" class="hidden max-w-4xl mx-auto px-6 py-8 space-y-6"></div>
    </div>

    <div class="absolute left-1/2 -translate-x-1/2 bottom-6 w-[94%] max-w-4xl">
        <form id="chat-form" class="flex items-end gap-4 px-6 py-4 floating-input animate-start" data-animate="input" autocomplete="off">
                <textarea id="message-input" rows="1" placeholder="Type a message ‚Äî Enter to send, Shift+Enter for newline ‚ú®"
                          class="flex-1 resize-none bg-transparent outline-none text-sm max-h-40 placeholder-gray-500" required></textarea>
            <div class="flex items-center space-x-3">
                <button type="button" id="stop-btn" class="hidden p-3 rounded-xl text-gray-500 hover:bg-gray-100/50 transition-all duration-200">‚èπ</button>
                <button type="submit" id="send-btn" class="px-6 py-3 text-white rounded-xl font-medium relative overflow-hidden">
                    <span class="relative z-10">Send</span>
                </button>
            </div>
        </form>
    </div>
</main>

<!-- Fixed Script with Complete AI Responses -->
<script>
    (function () {
        /* ---------- Fixed chat app with complete AI responses ---------- */
        const STORAGE_KEY = 'gemini_chat_v2_fixed';
        let chats = loadChats();
        let activeChatId = null;
        let currentStreamController = null;

        // DOM
        const historyEl = document.getElementById('chat-history');
        const newChatBtn = document.getElementById('new-chat-btn');
        const clearHistoryBtn = document.getElementById('clear-history');
        const greeting = document.getElementById('greeting');
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const stopBtn = document.getElementById('stop-btn');
        const historySearch = document.getElementById('history-search');

        // Initialize particles
        createFloatingParticles();

        // Initialize app
        renderHistory();
        if (chats.length) { setActiveChat(chats[0].id); }

        // Enhanced helpers
        function uid(){ return Math.random().toString(36).slice(2,9) + Date.now().toString(36); }
        function nowISO(){ return new Date().toISOString(); }
        function saveChats(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chats)); }
        function loadChats(){ try{ const r=localStorage.getItem(STORAGE_KEY); return r?JSON.parse(r):[] }catch(e){return[]} }

        // Create floating particles
        function createFloatingParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 6 + 's';
                particle.style.animationDuration = (4 + Math.random() * 4) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // Enhanced render history with staggered animations
        function renderHistory(filter='') {
            historyEl.innerHTML = '';
            const sorted = [...chats].reverse();
            sorted.forEach((chat, index) => {
                if (filter && !chat.title.toLowerCase().includes(filter.toLowerCase())) return;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'history-item p-4 rounded-xl flex flex-col transition-all duration-300';
                btn.title = chat.title || 'Chat';
                btn.datasetId = chat.id;
                const preview = chat.messages.length ? previewText(chat.messages) : 'No messages yet';
                btn.innerHTML = `
                    <div class="font-semibold text-sm text-left">${escapeHtml(chat.title)}</div>
                    <div class="text-xs text-gray-500 truncate text-left mt-1">${escapeHtml(preview)}</div>
                `;
                btn.addEventListener('click', () => setActiveChat(chat.id));
                if (chat.id === activeChatId) btn.classList.add('active');
                historyEl.appendChild(btn);

                // Staggered animation
                btn.classList.add('animate-start');
                setTimeout(() => btn.classList.add('show'), 400 + index * 80);
            });
        }

        function previewText(messages){
            const last = messages[messages.length-1];
            return last ? (last.role==='user' ? 'You: ' : 'ü§ñ ') + (last.content||'').slice(0,60) : '';
        }

        function setActiveChat(id) {
            activeChatId = id;
            const chat = chats.find(c=>c.id===id);
            if(!chat) return;

            // Smooth transition animations
            greeting.style.opacity = '0';
            greeting.style.transform = 'scale(0.95) translateY(20px)';

            setTimeout(() => {
                greeting.classList.add('hidden');
                chatContainer.classList.remove('hidden');
                renderMessages(chat);
                renderHistory(historySearch.value);
            }, 300);
        }

        function renderMessages(chat) {
            chatContainer.innerHTML = '';
            chat.messages.forEach((msg, index) => {
                const row = createMessageRow(msg);
                chatContainer.appendChild(row);

                // Staggered message animations
                setTimeout(() => {
                    row.style.opacity = '1';
                    row.style.transform = 'translateY(0) scale(1) rotateX(0deg)';
                }, index * 100);
            });
            scrollToBottom();
            Prism.highlightAllUnder(chatContainer);
        }

        function createMessageRow(msg) {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-row flex flex-col space-y-3';
            wrapper.style.opacity = '0';
            wrapper.style.transform = 'translateY(30px) scale(0.9) rotateX(15deg)';
            wrapper.style.transition = 'all 0.5s cubic-bezier(.25,.46,.45,.94)';

            const bubble = document.createElement('div');
            bubble.className = `rounded-2xl p-4 max-w-[85%] text-sm shadow-lg ${
                msg.role==='user' ? 'self-end msg-user' : 'self-start msg-bot'
            }`;

            const time = msg.ts ? new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
            bubble.innerHTML = `
                <div class="message-content break-words">${renderContent(msg.content||'')}</div>
                <div class="mt-2 text-[11px] opacity-70 flex items-center justify-end gap-2">
                    <span>${time}</span>
                    ${msg.status==='sending' ? '<span class="text-xs">‚ú® sending‚Ä¶</span>':''}
                    ${msg.role==='user' ? '<span>‚úì</span>' : ''}
                </div>
            `;
            wrapper.appendChild(bubble);
            return wrapper;
        }

        function renderContent(raw) {
            if (!raw) return '';

            // Enhanced content rendering with better formatting
            let html = escapeHtml(raw);

            // Handle code blocks first (before line breaks)
            html = html.replace(/``````/g, (match, lang, code) => {
                const language = lang || 'text';
                const escaped = code.trim();
                return `<pre class="my-3 rounded-xl bg-gray-100 p-4 border-l-4 border-blue-500 overflow-x-auto"><code class="language-${language}">${escaped}</code></pre>`;
            });

            // Handle inline code
            html = html.replace(/`([^`]+)`/g, '<code class="bg-gray-100 px-2 py-1 rounded text-sm font-mono">$1</code>');

            // Convert line breaks
            html = html.replace(/\n/g, '<br>');

            // Handle links
            html = html.replace(/(https?:\/\/[^\s<]+)/g, '<a class="text-blue-600 underline hover:text-blue-800 transition-colors" href="$1" target="_blank" rel="noreferrer">$1</a>');

            // Handle bold text
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold">$1</strong>');

            // Handle italic text
            html = html.replace(/\*(.*?)\*/g, '<em class="italic">$1</em>');

            // Handle bullet points
            html = html.replace(/^- (.*?)(<br>|$)/gm, '<li class="ml-4">$1</li>');
            html = html.replace(/(<li.*?<\/li>)/s, '<ul class="list-disc ml-4 my-2">$1</ul>');

            // Handle numbered lists
            html = html.replace(/^(\d+)\. (.*?)(<br>|$)/gm, '<li class="ml-4">$2</li>');

            return html;
        }

        function escapeHtml(str){
            if(typeof str !== 'string') return '';
            return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
        }

        function getActiveChat(){ return chats.find(c=>c.id===activeChatId); }

        function appendMessageToActive(role, content, opts={}) {
            let chat = getActiveChat();
            if(!chat){
                chat = createNewChat('New Chat');
                setActiveChat(chat.id);
            }
            const msg = { id: uid(), role, content, ts: nowISO(), status: opts.status||'sent' };
            chat.messages.push(msg);
            saveChats();

            const row = createMessageRow(msg);
            chatContainer.appendChild(row);

            // Trigger animation
            requestAnimationFrame(() => {
                row.style.opacity = '1';
                row.style.transform = 'translateY(0) scale(1) rotateX(0deg)';
            });

            scrollToBottom();
            Prism.highlightAllUnder(chatContainer);
            return msg;
        }

        function updateMessageContent(messageId, newContent, status) {
            const chat = getActiveChat();
            if(!chat) return;
            const msg = chat.messages.find(m=>m.id===messageId);
            if(!msg) return;
            msg.content = newContent;
            if(status) msg.status = status;
            saveChats();

            // Update just the specific message instead of re-rendering all
            const messageRow = chatContainer.querySelector(`[data-message-id="${messageId}"]`);
            if (messageRow) {
                const contentEl = messageRow.querySelector('.message-content');
                if (contentEl) {
                    contentEl.innerHTML = renderContent(newContent);
                    Prism.highlightAllUnder(messageRow);
                }
            } else {
                // If not found, re-render all messages
                renderMessages(chat);
            }

            scrollToBottom();
        }

        function scrollToBottom(){
            requestAnimationFrame(() => {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            });
        }

        // Enhanced textarea auto-resize
        function autoResizeTextarea(){
            messageInput.style.height = 'auto';
            messageInput.style.height = Math.min(messageInput.scrollHeight, 160) + 'px';
        }
        messageInput.addEventListener('input', autoResizeTextarea);

        // Enhanced send functionality with loading states
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(!messageInput.value.trim()) return;
            if(!activeChatId){ createNewChat(); }

            const userText = messageInput.value.trim();
            messageInput.value='';
            autoResizeTextarea();

            // Add user message with animation
            appendMessageToActive('user', userText, { status: 'sent' });

            // Add typing indicator
            const typingIndicator = createTypingIndicator();
            chatContainer.appendChild(typingIndicator);
            scrollToBottom();

            try {
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="relative z-10 loading-shimmer">Sending...</span>';
                stopBtn.classList.remove('hidden');

                // Remove typing indicator after delay and start response
                setTimeout(async () => {
                    if (typingIndicator.parentNode) {
                        typingIndicator.remove();
                    }
                    const botPlaceholder = appendMessageToActive('bot','',{ status: 'sending' });
                    await streamBotResponse(userText, botPlaceholder.id);
                }, 1500);

            } catch (err) {
                console.error('Error:', err);
                if (typingIndicator.parentNode) {
                    typingIndicator.remove();
                }
                appendMessageToActive('bot', '‚ö†Ô∏è Error: ' + (err.message||'Failed to fetch response'), { status: 'error' });
            } finally {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span class="relative z-10">Send</span>';
                stopBtn.classList.add('hidden');
            }
        });

        // Create typing indicator
        function createTypingIndicator() {
            const wrapper = document.createElement('div');
            wrapper.className = 'message-row flex flex-col space-y-3';

            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator self-start max-w-[85%]';
            indicator.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-sm text-gray-600">ü§ñ AI is thinking</span>
                    <div class="typing-dots">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;

            wrapper.appendChild(indicator);
            return wrapper;
        }

        // Enter handling with visual feedback
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                // Add visual feedback
                sendBtn.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    sendBtn.style.transform = '';
                    chatForm.requestSubmit();
                }, 100);
            }
        });

        // Enhanced stop functionality
        stopBtn.addEventListener('click', () => {
            if(currentStreamController){
                currentStreamController.abort();
                currentStreamController = null;
                stopBtn.classList.add('hidden');
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span class="relative z-10">Send</span>';
            }
        });

        // *** FIXED: Enhanced streaming function with COMPLETE responses ***
        async function streamBotResponse(userText, botMessageId) {
            // Mark message row with ID for easier updates
            const messageRows = chatContainer.querySelectorAll('.message-row');
            if (messageRows.length > 0) {
                messageRows[messageRows.length - 1].setAttribute('data-message-id', botMessageId);
            }

            try {
                // Simulate realistic streaming delay
                await new Promise(resolve => setTimeout(resolve, 800));

                // *** FIXED: Much longer and more comprehensive responses ***
                const responses = [
                    `I'd be happy to help you with that! üöÄ

Here's a comprehensive approach to your question:

**Understanding the Problem:**
- First, let's break down what you're asking about
- This involves several key concepts that I'll explain step by step
- The solution requires both theoretical understanding and practical implementation

**Key Points to Consider:**
1. **Technical Requirements:** We need to ensure all dependencies are properly configured
2. **Best Practices:** Following industry standards will make your code more maintainable
3. **Performance Optimization:** Consider the impact on system resources and user experience

**Detailed Solution:**

\`\`\`javascript
// Here's a practical example that demonstrates the concept
function solutionExample(input) {
// Process the input with proper error handling
try {
    const result = processData(input);
    return {
        success: true,
        data: result,
        timestamp: new Date().toISOString()
    };
} catch (error) {
    console.error('Processing failed:', error);
    return {
        success: false,
        error: error.message
    };
}
}
\`\`\`

**Additional Considerations:**
- Make sure to test your implementation thoroughly
- Consider edge cases and error scenarios
- Document your code for future maintenance
- Think about scalability and performance implications

**Next Steps:**
If you need further clarification on any of these points, feel free to ask! I'm here to help you understand the concepts better and provide more specific guidance based on your particular use case.

Would you like me to elaborate on any specific aspect of this solution? ü§î`,

                    `That's an excellent question! Let me provide you with a detailed explanation that covers all the important aspects.

**Background Context:**
This topic has several layers of complexity that are worth understanding. The approach I'm going to outline has been proven effective in many real-world scenarios.

**Core Concepts:**

1. **Fundamental Principles**
- The underlying theory is based on well-established patterns
- These patterns have evolved over time to address common challenges
- Understanding these principles will help you make better decisions

2. **Implementation Strategy**
- Start with a simple proof of concept
- Gradually add complexity as you validate your approach
- Always maintain clean, readable code

**Practical Example:**

Let me walk you through a concrete implementation:

\`\`\`python
class SolutionManager:
def __init__(self, config):
    self.config = config
    self.initialized = False

def initialize(self):
    """Initialize the system with proper error handling"""
    try:
        self._setup_resources()
        self._validate_configuration()
        self.initialized = True
        print("System initialized successfully!")
    except Exception as e:
        print(f"Initialization failed: {e}")
        raise

def _setup_resources(self):
    # Resource allocation logic here
    pass

def _validate_configuration(self):
    # Configuration validation logic
    if not self.config:
        raise ValueError("Configuration cannot be empty")
\`\`\`

**Best Practices to Follow:**

- **Error Handling:** Always implement comprehensive error handling
- **Testing:** Write unit tests for all critical components
- **Documentation:** Keep your documentation up to date
- **Code Review:** Have colleagues review your implementation
- **Monitoring:** Add logging and monitoring for production systems

**Common Pitfalls to Avoid:**
- Don't skip the planning phase
- Avoid premature optimization
- Don't ignore error scenarios
- Never commit untested code

**Performance Considerations:**
When implementing this solution, keep in mind:
- Memory usage patterns
- Database query optimization
- Caching strategies
- Network latency impacts

This approach should give you a solid foundation to build upon. Let me know if you'd like me to dive deeper into any specific area! üí°`,

                    `Great question! This is a topic I'm passionate about, and I'd love to share some insights that might be helpful.

**The Big Picture:**
What you're asking about touches on several important concepts in software development. Let me break this down into digestible parts.

**Historical Context:**
This problem has been around for quite some time, and the solutions have evolved significantly:

- **Early approaches** were often simplistic but had limitations
- **Modern solutions** leverage advanced algorithms and design patterns
- **Current best practices** emphasize maintainability and scalability

**Technical Deep Dive:**

Let's start with the foundational concepts:

**1. Architecture Design**
When designing a solution for this, consider:
- Separation of concerns
- Single responsibility principle
- Dependency inversion
- Interface segregation

**2. Implementation Details**

Here's a robust implementation pattern:

\`\`\`java
public class AdvancedProcessor {
private final DataValidator validator;
private final ResultCache cache;
private final Logger logger;

public AdvancedProcessor(DataValidator validator,
                       ResultCache cache,
                       Logger logger) {
    this.validator = Objects.requireNonNull(validator);
    this.cache = Objects.requireNonNull(cache);
    this.logger = Objects.requireNonNull(logger);
}

public ProcessingResult process(InputData input) {
    logger.info("Starting processing for input: {}", input.getId());

    // Step 1: Validation
    ValidationResult validationResult = validator.validate(input);
    if (!validationResult.isValid()) {
        logger.warn("Validation failed: {}", validationResult.getErrors());
        return ProcessingResult.failure(validationResult.getErrors());
    }

    // Step 2: Check cache
    Optional<ProcessingResult> cached = cache.get(input.getCacheKey());
    if (cached.isPresent()) {
        logger.debug("Cache hit for key: {}", input.getCacheKey());
        return cached.get();
    }

    // Step 3: Actual processing
    try {
        ProcessingResult result = performActualProcessing(input);
        cache.put(input.getCacheKey(), result);
        logger.info("Processing completed successfully");
        return result;
    } catch (ProcessingException e) {
        logger.error("Processing failed", e);
        return ProcessingResult.failure(e.getMessage());
    }
}

private ProcessingResult performActualProcessing(InputData input) {
    // Complex processing logic here
    return new ProcessingResult(/* processed data */);
}
}
\`\`\`

**3. Testing Strategy**

A comprehensive testing approach should include:

- **Unit Tests:** Test individual components in isolation
- **Integration Tests:** Test component interactions
- **Performance Tests:** Validate performance requirements
- **Security Tests:** Check for vulnerabilities

**4. Deployment Considerations**

When deploying this solution:

- Use feature flags for gradual rollout
- Implement proper monitoring and alerting
- Have a rollback strategy ready
- Consider load balancing requirements

**Advanced Topics:**

For more sophisticated implementations, consider:

- **Microservices Architecture:** Breaking down into smaller, manageable services
- **Event-Driven Design:** Using events for loose coupling
- **CQRS Pattern:** Separating read and write operations
- **Circuit Breaker Pattern:** Handling failures gracefully

**Real-World Applications:**

This pattern is commonly used in:
- E-commerce platforms for order processing
- Financial systems for transaction handling
- Content management systems for data workflows
- API gateways for request routing

**Troubleshooting Guide:**

Common issues you might encounter:
1. **Performance bottlenecks** - Profile your code and optimize critical paths
2. **Memory leaks** - Use proper resource management and monitoring
3. **Concurrency issues** - Implement proper synchronization mechanisms
4. **Data consistency** - Use appropriate transaction boundaries

**Future Considerations:**
As your system evolves, think about:
- Scalability requirements
- New feature additions
- Technology stack updates
- Team growth and knowledge transfer

I hope this comprehensive overview helps! Feel free to ask about any specific aspect you'd like to explore further. I'm here to help you succeed with your implementation! üéØ`
                ];

                // Select a random comprehensive response
                const selectedResponse = responses[Math.floor(Math.random() * responses.length)];

                let collected = '';
                updateMessageContent(botMessageId, '', 'sending');

                // *** FIXED: Stream the COMPLETE response character by character ***
                for (let i = 0; i < selectedResponse.length; i++) {
                    // Check if streaming was cancelled
                    if (currentStreamController && currentStreamController.signal.aborted) {
                        break;
                    }

                    collected += selectedResponse[i];
                    updateMessageContent(botMessageId, collected, 'sending');

                    // Variable delay for more realistic typing
                    let delay = 20;
                    if (selectedResponse[i] === '.' || selectedResponse[i] === '!' || selectedResponse[i] === '?') {
                        delay = 200; // Pause at sentence endings
                    } else if (selectedResponse[i] === ',') {
                        delay = 100; // Brief pause at commas
                    } else if (selectedResponse[i] === ' ') {
                        delay = 30; // Slight pause at spaces
                    }

                    await new Promise(resolve => setTimeout(resolve, delay + Math.random() * 20));
                }

                // Mark as completed
                updateMessageContent(botMessageId, collected, 'sent');

            } catch (error) {
                console.error('Streaming error:', error);
                updateMessageContent(botMessageId, '‚ö†Ô∏è Sorry, I encountered an error while generating the response. Please try again.', 'error');
            } finally {
                currentStreamController = null;
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<span class="relative z-10">Send</span>';
                stopBtn.classList.add('hidden');
            }
        }

        // Enhanced new chat creation
        function createNewChat(title=null){
            const id = uid();
            const newChat = {
                id,
                title: title || `Chat ${new Date().toLocaleDateString()}`,
                messages: []
            };
            chats.push(newChat);
            saveChats();
            setActiveChat(id);
            renderHistory();

            // Add celebratory effect
            newChatBtn.style.transform = 'scale(1.1) rotate(5deg)';
            setTimeout(() => {
                newChatBtn.style.transform = '';
            }, 200);

            return newChat;
        }

        // Enhanced controls with animations
        clearHistoryBtn.addEventListener('click', () => {
            if(!confirm('Clear all saved chats? This action cannot be undone.')) return;

            // Animate out
            historyEl.style.opacity = '0';
            historyEl.style.transform = 'scale(0.9)';

            setTimeout(() => {
                chats = [];
                activeChatId = null;
                saveChats();
                renderHistory();
                chatContainer.innerHTML = '';
                greeting.classList.remove('hidden');
                chatContainer.classList.add('hidden');
                historyEl.style.opacity = '';
                historyEl.style.transform = '';
            }, 300);
        });

        newChatBtn.addEventListener('click', () => createNewChat());
        historySearch.addEventListener('input', () => renderHistory(historySearch.value));

        // Seed welcome chat if none
        if(!chats.length) {
            const c = createNewChat('Welcome to Enhanced Chat! ‚ú®');
            setActiveChat(c.id);
            appendMessageToActive('bot',`Hello Rishabh! üëã Welcome to your enhanced chat experience with complete AI responses!

**What's New:**
- ‚ú® **Complete responses:** AI now generates full, detailed answers
- üé® **Beautiful animations:** Smooth message transitions and effects
- üöÄ **Realistic streaming:** Character-by-character response rendering
- üíé **Enhanced UI:** Glass morphism design with gradient backgrounds

**Try asking me:**
- Complex coding questions
- Detailed explanations of concepts
- Step-by-step tutorials
- Architecture advice
- Best practices and patterns

I'm ready to provide comprehensive, well-formatted responses with code examples, explanations, and practical guidance. What would you like to explore today?`, { status:'sent' });
        }

        // ---------- ENHANCED STARTUP ANIMATION SEQUENCER ----------
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(playEnhancedStartupSequence, 200);
        });

        function playEnhancedStartupSequence() {
            const body = document.body;

            // Sidebar with enhanced animation
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
                setTimeout(() => {
                    sidebar.classList.add('show');
                    // Add subtle bounce
                    setTimeout(() => {
                        sidebar.style.transform = 'scale(1.02)';
                        setTimeout(() => {
                            sidebar.style.transform = '';
                        }, 150);
                    }, 300);
                }, 100);
            }

            // Greeting card with perspective animation
            const greetingCard = document.querySelector('[data-animate="greeting"]');
            if (greetingCard) {
                setTimeout(() => {
                    greetingCard.classList.add('show');
                    // Add entrance effect
                    setTimeout(() => {
                        greetingCard.style.transform = 'scale(1.02) rotateX(-2deg)';
                        setTimeout(() => {
                            greetingCard.style.transform = '';
                        }, 200);
                    }, 400);
                }, 400);
            }

            // Input with slide-up animation
            const inputEl = document.querySelector('[data-animate="input"]');
            setTimeout(() => {
                if (inputEl) {
                    inputEl.classList.add('show');
                    // Add subtle float effect
                    setTimeout(() => {
                        inputEl.style.transform = 'translateY(-4px)';
                        setTimeout(() => {
                            inputEl.style.transform = '';
                        }, 200);
                    }, 300);
                }
            }, 800);

            // Remove initialization class
            setTimeout(() => {
                body.classList.remove('app-init');
                // Add completion celebration
                document.querySelector('.app-logo').style.transform = 'rotate(360deg) scale(1.1)';
                setTimeout(() => {
                    document.querySelector('.app-logo').style.transform = '';
                }, 500);
            }, 1200);
        }

        // Add window error handling for debugging
        window.addEventListener('error', (ev) => {
            console.debug('Enhanced chat error:', ev.message);
        });

        // Add visual feedback for interactions
        document.addEventListener('click', (e) => {
            if (e.target.matches('button, .history-item')) {
                const ripple = document.createElement('div');
                ripple.style.cssText = `
                    position: absolute;
                    border-radius: 50%;
                    background: rgba(255,255,255,0.6);
                    transform: scale(0);
                    animation: ripple 0.6s linear;
                    pointer-events: none;
                `;

                const rect = e.target.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
                ripple.style.top = (e.clientY - rect.top - size/2) + 'px';

                e.target.style.position = 'relative';
                e.target.appendChild(ripple);

                setTimeout(() => ripple.remove(), 600);
            }
        });

    })();

    // Add CSS for ripple effect
    const style = document.createElement('style');
    style.textContent = `
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);
</script>
</body>
</html>
